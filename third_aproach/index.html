<!DOCTYPE html>
<html lang="en">

<head>
	<base target="_top">
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<title>Choropleth Tutorial - Leaflet</title>

	<link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />

	<link rel="stylesheet" href="../data/leaflet.css"
		integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
		integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
	<script src="http://unpkg.com/leaflet@latest/dist/leaflet.js"></script>
	<script src="js/leaflet-providers.js"></script>

	<style>
		html,
		body {
			height: 100%;
			margin: 0;
			display: flex;
			justify-content: center;
			align-items: center;
		}

		.leaflet-container {
			height: 100%;
			width: 100%;
		}

		/* .leaflet-container {
			height: 400px;
			width: 600px;
			max-width: 100%;
			max-height: 100%;
		} */
		#map {
			width: 550px;
			height: 500px;
		}

		.info {
			padding: 6px 8px;
			font: 14px/16px Arial, Helvetica, sans-serif;
			/* background: rgb(0, 0, 0); */
			background: rgba(255, 255, 255, 0.8);
			box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
			border-radius: 5px;
		}

		.info h4 {
			margin: 0 0 0px;
			color: #000000;
		}

		.legend {
			text-align: left;
			line-height: 18px;
			color: #555;
		}

		.legend i {
			width: 18px;
			height: 18px;
			float: left;
			margin-right: 8px;
			opacity: 0.7;
		}
	</style>
</head>

<body>
	<div class="centered-content">
		<div class="graph-text main-text">
			<h1 class="oracion">
				Mapa interactivo de los diferentes entrenadores por países
			</h1>
		</div>

		<div id="selectors" onchange="updateMap()" display="block"><span>Deportes:&nbsp;</span>
			<select id="sport">
				<option value="baseball"> Béisbol</option>
				<option value="voly"> Volleyball</option>
				<option value="futbol"> Fútbol</option>
				<option value="rugby"> Rugby</option>
				<option value="handball"> Balonmano</option>
				<option value="softball"> Softball</option>
				<option value="polo"> Polo</option>
				<option value="hockey"> Hockey</optio>
				<option value="basket"> Baloncesto</option>
			</select>

			<span>Género:&nbsp;</span>
			<select id="team_sex">
				<option value="female">Femenino</option>
				<option value="male">Masculino</option>
			</select>

			<span>Entrenadores:&nbsp;</span>
			<select id="trainer_sex">
				<option value="all">Todos</option>
				<option value="female">Mujeres</option>
				<option value="male">Hombres</option>
			</select>

			<span>Desarrollo:&nbsp;</span>
			<select id="development">
				<option value="all">Todos</option>
				<option value="">Desarrollado</option>
				<option value="">En desarrollo</option>
			</select>

			<span>Continent:&nbsp;</span>
			<select id="continent">
				<option value="all">Todos</option>
				<option value="África">África</option>
				<option value="Australia y Oceanía">Australia y Oceanía</option>
				<option value="América">América</option>
				<option value="Europa">Europa</option>
				<option value="Asia">Asia</option>
			</select>

			<br><br>
		</div>


		<div id='map' display="block"></div>

		<script type="text/javascript" src="countries.js"></script>
		<!-- <script type="text/javascript" src="data.js"></script> -->
		<script type="text/javascript">

			// carga los datos del data.json !!! fijarse que la direccion
			// del json este correcta 
			async function loadCountryData() {
				const response = await fetch("../data/data.json");
				const data = await response.json();
				return data;
			}

			// carga la bse de datos
			// const database = await loadCountryData();

			// carga el valor de los filtros
			// let sport_f = document.getElementById("sport").value;
			// let team_sex_f = document.getElementById("team_sex").value;
			// let trainer_sex_f = document.getElementById("trainer_sex").value;
			// let development_f = document.getElementById("development").value;

			async function passes_filter(id) {


				const database = await loadCountryData();

				const sport = document.getElementById("sport").value;
				const team_sex = document.getElementById("team_sex").value;
				const trainer_sex = document.getElementById("trainer_sex").value;
				const development = document.getElementById("development").value;
				const continent = document.getElementById("continent").value;

				const countries = database.sports[sport][team_sex].countries;

				let bool;
				let ans;
				await countries.forEach(team => {
					let condition = team.country_id == id;
					// console.log(condition);
					if (condition) {
						if (trainer_sex != "all" && condition) { condition = trainer_sex == team.manager_sex; }
						if (development != "all" && condition) { condition = development == database.countries[id].development; }
						if (continent != "all" && condition) { condition = continent == database.countries[id].continent; }
						bool = condition;
						ans = team;
					}
				});
				if (bool) { return ans; }
				else { return undefined; }
			}

			// funcion para crear el popup a partir de los filtros
			async function get_filtered_popup(id) {
				const database = await loadCountryData();
				let obj = await passes_filter(id);
				// await console.log(obj);
				if (obj != undefined) {

					const name = database.countries[id].country_name;
					const text =
						name + "\n" +
						obj.manager_name + "\n" +
						obj.result;
					return text;
				}
				return "no participo";
			}


			// si el pais con (id) pasa los filtros (el resto de los argumentos)
			// lo retorna. si no, devuelve undefined



			// Halla los filtros de los select y devuelve un array con los id
			// de los paises que los cumplen
			async function get_filtered_list() {
				const array = [];
				const countries_arr = countriesData.features;
				for(i=0;i<countries_arr.length;i++){
					let curr = countries_arr[i];
					let f= await passes_filter(curr.id);
					if(f!=undefined){
						array.push(curr.id);
					}
				}
				console.log(array);
				return array;
			}


			const map = L.map('map').setView([0, 0], 1, 5);

			// control that shows state info on hover
			const info = L.control();

			info.onAdd = function (map) {
				this._div = L.DomUtil.create('div', 'info');
				this.update();
				return this._div;
			};

			info.update = function (props) {
				this._div.innerHTML = `<h4>Countrie Important Info</h4>`;
			};

			info.addTo(map);

			const tiles = L.tileLayer('Thunderforest.Transport', {
				maxZoom: 5,
				minZoom: 1,
				attribution: '&copy; <a href="http://www.thunderforest.com/">Thunderforest</a>, contributors',
			}).addTo(map);

			// get color depending on majority of data
			function getColor(id) {
				const r = Object.keys(database.countries).find(id);
				if (r == undefined) { return "red"; }
				return "yellow";
			}

			async function style(feature) {

				return {
					weight: 2,
					opacity: 1,
					color: 'white',
					dashArray: '3',
					fillOpacity: 0.7,
					fillColor: "red"//getColor(feature.id),
				};
			}

			/* global statesData */
			const geojson = L.geoJson(countriesData, {
				style,
				onEachFeature
			}).addTo(map);

			geojson.eachLayer(function (layer) {
				const database = loadCountryData();
				const id = layer.feature.id;
				const country_id = Object.keys(database.countries).find(country_id => country_id == id);
				if (country_id != undefined) { layer.bindPopup(database.countries[country_id].country_name); }
			});


			function onMouseOver(e) {
				// function highlightFeature(e) {
				// 	const layer = e.target;
				// 	layer.setStyle({
				// 		weight: 5,
				// 		dashArray: "",
				// 		fillOpacity: 0.7
				// 	});
				// 	layer.bringToFront();
				// 	info.update(layer.feature.properties);
				// }
				// highlightFeature(e);
			}


			function onMouseOut(e) {

				// function resetHighlight(e) {
				// 	geojson.resetStyle(e.target);
				// 	info.update();
				// }
				// resetHighlight(e);

			}

			async function onClick(e) {
				// map.fitBounds(e.target.getBounds());
				let layer = e.target; // gets layer
				const country_id = layer.feature.id; // get id del pais
				// await console.log(country_id);
				// const countryName = database.countries[country_id].country_name;
				var popupContent = await get_filtered_popup(country_id);
				// await console.log(popupContent);
				layer.bindPopup(popupContent).openPopup();
			}



			function onEachFeature(feature, layer) {
				// layer.bindPopup('<p>Hello world!<br />This is a nice popup.</p>'),
				layer.on({
					mouseover: onMouseOver,
					mouseout: onMouseOut,
					click: onClick
				});
			}

			async function updateMap() {
				let activeCountries = await get_filtered_list();
				// await console.log(activeCountries);
				await geojson.eachLayer(function (layer) {
					const id = layer.feature.id;
					let color = "red";
					if(activeCountries.includes(id)){color = "pink"}
					layer.setStyle( {fillColor:color});
					geojson.addTo(map);
				}
				)
			};


			// Map Atribution
			map.attributionControl.addAttribution('copyrigth info; <a href="http://source.cu/">Source</a>');

			//Creacion e instanciacion de la Leyenda con el significado de los colores del mapa
			const legend = L.control({ position: 'bottomright' });
			legend.onAdd = function (map) {

				const div = L.DomUtil.create('div', 'info legend');
				const grades = [0, 10, 20, 50, 100, 200, 500, 1000];
				const labels = [];
				let from, to;

				for (let i = 0; i < grades.length; i++) {
					from = grades[i];
					to = grades[i + 1];

					labels.push(`<i style="background:${getColor(from + 1)}"></i> ${from}${to ? `&ndash;${to}` : '+'}`);
				}

				div.innerHTML = labels.join('<br>');
				return div;
			};
			legend.addTo(map);
			// Leyenda End

			map.on('click', onMapClick);


		</script>



</body>

</html>